name: build-and-pack

on:
  push:
    branches: [ "main" ]
    tags:     [ "v*" ]   # v1.2.3 gibi

jobs:
  pack:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # TAG’leri görebilsin

      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Derive version
        id: ver
        shell: bash
        run: |
          ref_type="${GITHUB_REF_TYPE}"           # 'branch' veya 'tag'
          ref_name="${GITHUB_REF_NAME}"           # örn: main veya v1.2.3
          if [[ "$ref_type" == "tag" && "$ref_name" =~ ^v?[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z\.-]+)?$ ]]; then
            ver="${ref_name#v}"                   # v1.2.3 -> 1.2.3
          else
            ver="0.1.0-ci.${GITHUB_RUN_NUMBER}"   # örn: 0.1.0-ci.123
          fi
          echo "version=$ver"
          echo "version=$ver" >> $GITHUB_OUTPUT

      - name: Restore (CLI)
        run: dotnet restore ./SwarmBender.Cli/SwarmBender.Cli.csproj

      - name: Build (CLI)
        run: dotnet build ./SwarmBender.Cli/SwarmBender.Cli.csproj -c Release --no-restore

      - name: Pack (CLI)
        run: dotnet pack ./SwarmBender.Cli/SwarmBender.Cli.csproj -c Release --no-build -o ./nupkgs /p:Version=${{ steps.ver.outputs.version }}

      # (Opsiyonel) NuGet publish — yalnızca tag ile çalıştırmak istersen if ekleyebilirsin
      - name: Push to NuGet
        if: startsWith(github.ref, 'refs/tags/v') && secrets.NUGET_API_KEY != ''
        run: dotnet nuget push ./nupkgs/*.nupkg --api-key "${{ secrets.NUGET_API_KEY }}" --source https://api.nuget.org/v3/index.json --skip-duplicate